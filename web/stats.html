<!doctype html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
  <title>Statistiche - AppuntiApp</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root[data-theme="dark"]{--bg:#0b0f12;--panel:#0f1720;--text:#e6eef6;--muted:#98a0ac;--accent:#4cc9f0;--border:rgba(255,255,255,0.07);--hover:rgba(255,255,255,0.05)}
    :root[data-theme="light"]{--bg:#f5f7fa;--panel:#ffffff;--text:#1a202c;--muted:#718096;--accent:#0066cc;--border:rgba(0,0,0,0.1);--hover:rgba(0,0,0,0.03)}
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;padding:28px;transition:background 0.2s}
    .wrap{max-width:1400px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;flex-wrap:wrap;gap:16px}
    h1{font-size:32px;margin:0}
    .header-actions{display:flex;gap:8px;align-items:center}
    .btn{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px;text-decoration:none;transition:background 0.15s;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{background:var(--hover)}
    .theme-toggle{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:4px;display:flex;gap:4px}
    .theme-toggle button{background:transparent;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px;color:var(--muted);transition:all 0.15s}
    .theme-toggle button.active{background:var(--accent);color:white}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:32px}
    .stat-card{background:var(--panel);padding:24px;border-radius:12px;border:1px solid var(--border)}
    .stat-card h3{font-size:13px;text-transform:uppercase;letter-spacing:0.5px;color:var(--muted);margin-bottom:12px}
    .stat-card .value{font-size:36px;font-weight:700;color:var(--text);margin-bottom:8px}
    .stat-card .label{font-size:13px;color:var(--muted)}
    .chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-bottom:32px}
    .chart-card{background:var(--panel);padding:24px;border-radius:12px;border:1px solid var(--border)}
    .chart-card h3{margin-bottom:20px;font-size:18px;color:var(--text)}
    .chart-container{position:relative;height:300px}
    .table-card{background:var(--panel);padding:24px;border-radius:12px;border:1px solid var(--border);margin-bottom:32px}
    .table-card h3{margin-bottom:20px;font-size:18px;color:var(--text)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
    th{color:var(--muted);font-weight:600;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    td{color:var(--text);font-size:14px}
    tr:hover{background:var(--hover)}
    .tag-badge{background:var(--accent);color:white;padding:4px 10px;border-radius:12px;font-size:11px;display:inline-block;margin-right:6px}
    .loading{text-align:center;padding:60px;color:var(--muted)}
    @media (max-width:900px){.stats-grid{grid-template-columns:1fr}.chart-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üìä Statistiche</h1>
      <div class="header-actions">
        <div class="theme-toggle">
          <button onclick="setTheme('dark')" data-theme="dark" class="active">üåô</button>
          <button onclick="setTheme('light')" data-theme="light">‚òÄÔ∏è</button>
        </div>
        <a href="preview.html" class="btn">‚Üê Torna alla Home</a>
      </div>
    </header>

    <div id="loading" class="loading">Caricamento statistiche...</div>

    <div id="stats-content" style="display:none">
      <div class="stats-grid">
        <div class="stat-card">
          <h3>üìÑ File Totali</h3>
          <div class="value" id="total-files">-</div>
          <div class="label">Documenti Markdown</div>
        </div>
        <div class="stat-card">
          <h3>üìù Parole Totali</h3>
          <div class="value" id="total-words">-</div>
          <div class="label">Conteggio parole</div>
        </div>
        <div class="stat-card">
          <h3>üíæ Dimensione Totale</h3>
          <div class="value" id="total-size">-</div>
          <div class="label">Spazio utilizzato</div>
        </div>
        <div class="stat-card">
          <h3>üìä Media Parole</h3>
          <div class="value" id="avg-words">-</div>
          <div class="label">Per documento</div>
        </div>
      </div>

      <div class="chart-grid">
        <div class="chart-card">
          <h3>üìà Top 10 File per Parole</h3>
          <div class="chart-container">
            <canvas id="words-chart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>üè∑Ô∏è Distribuzione Tag</h3>
          <div class="chart-container">
            <canvas id="tags-chart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-grid">
        <div class="chart-card">
          <h3>üìÖ Attivit√† Recente</h3>
          <div class="chart-container">
            <canvas id="activity-chart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>üìÇ File per Cartella</h3>
          <div class="chart-container">
            <canvas id="folders-chart"></canvas>
          </div>
        </div>
      </div>

      <div class="table-card">
        <h3>üìã File Pi√π Recenti</h3>
        <table>
          <thead>
            <tr>
              <th>Nome File</th>
              <th>Parole</th>
              <th>Dimensione</th>
              <th>Ultima Modifica</th>
            </tr>
          </thead>
          <tbody id="recent-files-table"></tbody>
        </table>
      </div>

      <div class="table-card">
        <h3>üè∑Ô∏è Tutti i Tag</h3>
        <div id="all-tags"></div>
      </div>
    </div>
  </div>

  <script>
    // Gestione tema
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      document.querySelectorAll('.theme-toggle button').forEach(b => {
        b.classList.toggle('active', b.dataset.theme === theme);
      });
      
      // Aggiorna colori chart
      Chart.defaults.color = theme === 'dark' ? '#98a0ac' : '#718096';
      Chart.defaults.borderColor = theme === 'dark' ? 'rgba(255,255,255,0.07)' : 'rgba(0,0,0,0.1)';
      loadStats();
    }
    const savedTheme = localStorage.getItem('theme') || 'dark';
    setTheme(savedTheme);

    // Utility
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function formatDate(timestamp) {
      const date = new Date(timestamp * 1000);
      return date.toLocaleDateString('it-IT') + ' ' + date.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});
    }

    // Carica stats
    async function loadStats() {
      try {
        const res = await fetch('/api/stats');
        const data = await res.json();
        
        // Stats base
        document.getElementById('total-files').textContent = data.total_files;
        document.getElementById('total-words').textContent = data.total_words.toLocaleString('it-IT');
        document.getElementById('total-size').textContent = formatBytes(data.total_size);
        document.getElementById('avg-words').textContent = Math.round(data.total_words / data.total_files);

        // Top 10 file per parole
        const topFiles = data.recent_files
          .sort((a, b) => b.word_count - a.word_count)
          .slice(0, 10);
        
        createBarChart('words-chart', 
          topFiles.map(f => f.name.substring(0, 25)),
          topFiles.map(f => f.word_count),
          'Parole'
        );

        // Tag distribution
        const tagEntries = Object.entries(data.tags).sort((a, b) => b[1] - a[1]).slice(0, 10);
        createPieChart('tags-chart',
          tagEntries.map(t => t[0]),
          tagEntries.map(t => t[1])
        );

        // Attivit√† recente (ultimi 7 giorni)
        const now = Date.now() / 1000;
        const days = 7;
        const dayLabels = [];
        const dayCounts = [];
        
        for (let i = days - 1; i >= 0; i--) {
          const dayStart = now - (i * 86400);
          const dayEnd = dayStart + 86400;
          const date = new Date(dayStart * 1000);
          dayLabels.push(date.toLocaleDateString('it-IT', {weekday: 'short', day: 'numeric'}));
          
          const count = data.recent_files.filter(f => 
            f.modified >= dayStart && f.modified < dayEnd
          ).length;
          dayCounts.push(count);
        }
        
        createLineChart('activity-chart', dayLabels, dayCounts, 'Modifiche');

        // File per cartella
        const folderCounts = {};
        data.recent_files.forEach(f => {
          const folder = f.path.includes('/') ? f.path.split('/')[0] : 'Root';
          folderCounts[folder] = (folderCounts[folder] || 0) + 1;
        });
        
        const folderEntries = Object.entries(folderCounts).sort((a, b) => b[1] - a[1]);
        createDoughnutChart('folders-chart',
          folderEntries.map(f => f[0]),
          folderEntries.map(f => f[1])
        );

        // Tabella file recenti
        const tableBody = document.getElementById('recent-files-table');
        tableBody.innerHTML = data.recent_files.slice(0, 15).map(f => `
          <tr>
            <td><a href="${f.path.replace(/\.md$/, '.html')}" style="color:var(--accent)">${f.name}</a></td>
            <td>${f.word_count.toLocaleString('it-IT')}</td>
            <td>${formatBytes(f.word_count * 6)}</td>
            <td>${formatDate(f.modified)}</td>
          </tr>
        `).join('');

        // Tutti i tag
        const allTags = document.getElementById('all-tags');
        allTags.innerHTML = Object.entries(data.tags)
          .sort((a, b) => b[1] - a[1])
          .map(([tag, count]) => `<span class="tag-badge">${tag} (${count})</span>`)
          .join('');

        // Mostra contenuto
        document.getElementById('loading').style.display = 'none';
        document.getElementById('stats-content').style.display = 'block';
        
      } catch (e) {
        document.getElementById('loading').innerHTML = '<p style="color:var(--error)">Errore caricamento statistiche. Il server √® attivo?</p>';
      }
    }

    // Chart creators
    function createBarChart(canvasId, labels, data, label) {
      const ctx = document.getElementById(canvasId);
      if (ctx.chart) ctx.chart.destroy();
      
      ctx.chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: data,
            backgroundColor: 'rgba(76, 201, 240, 0.6)',
            borderColor: 'rgba(76, 201, 240, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function createPieChart(canvasId, labels, data) {
      const ctx = document.getElementById(canvasId);
      if (ctx.chart) ctx.chart.destroy();
      
      const colors = [
        '#4cc9f0', '#4895ef', '#4361ee', '#3f37c9', '#3a0ca3',
        '#7209b7', '#f72585', '#fb5607', '#ff006e', '#8338ec'
      ];
      
      ctx.chart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 2,
            borderColor: 'var(--panel)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right' }
          }
        }
      });
    }

    function createLineChart(canvasId, labels, data, label) {
      const ctx = document.getElementById(canvasId);
      if (ctx.chart) ctx.chart.destroy();
      
      ctx.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: data,
            borderColor: 'rgba(76, 201, 240, 1)',
            backgroundColor: 'rgba(76, 201, 240, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });
    }

    function createDoughnutChart(canvasId, labels, data) {
      const ctx = document.getElementById(canvasId);
      if (ctx.chart) ctx.chart.destroy();
      
      const colors = [
        '#4cc9f0', '#4895ef', '#4361ee', '#3f37c9', '#3a0ca3',
        '#7209b7', '#f72585', '#fb5607', '#ff006e', '#8338ec'
      ];
      
      ctx.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 2,
            borderColor: 'var(--panel)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right' }
          }
        }
      });
    }

    // Init
    loadStats();
  </script>
</body>
</html>
