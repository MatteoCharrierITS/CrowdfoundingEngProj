<!doctype html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
  <title>Editor - AppuntiApp</title>
  <style>
    :root[data-theme="dark"]{--bg:#0b0f12;--panel:#0f1720;--text:#e6eef6;--muted:#98a0ac;--accent:#4cc9f0;--border:rgba(255,255,255,0.07);--hover:rgba(255,255,255,0.05);--success:#10b981;--error:#ef4444}
    :root[data-theme="light"]{--bg:#f5f7fa;--panel:#ffffff;--text:#1a202c;--muted:#718096;--accent:#0066cc;--border:rgba(0,0,0,0.1);--hover:rgba(0,0,0,0.03);--success:#10b981;--error:#ef4444}
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;transition:background 0.2s}
    .top-bar{background:var(--panel);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;gap:16px;position:sticky;top:0;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .file-name{font-size:16px;font-weight:600}
    .actions{display:flex;gap:8px}
    .btn{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;transition:all 0.15s;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{background:var(--hover)}
    .btn.primary{background:var(--accent);color:white;border-color:var(--accent)}
    .btn.primary:hover{opacity:0.9}
    .theme-toggle{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:4px;display:flex;gap:4px}
    .theme-toggle button{background:transparent;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px;color:var(--muted);transition:all 0.15s}
    .theme-toggle button.active{background:var(--accent);color:white}
    .editor-wrap{display:grid;grid-template-columns:1fr 1fr;height:calc(100vh - 70px);gap:0;margin-top:0}
    .editor-pane{display:flex;flex-direction:column;border-right:1px solid var(--border)}
    .editor-pane:last-child{border-right:none}
    .pane-header{background:var(--panel);padding:12px 20px;border-bottom:1px solid var(--border);font-size:13px;font-weight:500;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
    .editor-container{flex:1;overflow:auto}
    textarea{width:100%;height:100%;padding:20px;background:var(--bg);color:var(--text);border:none;font-family:'Fira Code',Consolas,Monaco,monospace;font-size:14px;line-height:1.6;resize:none;outline:none}
    .preview-container{padding:20px;overflow:auto;background:var(--panel)}
    .preview-container h1,.preview-container h2,.preview-container h3{margin-top:24px;margin-bottom:12px;color:var(--text)}
    .preview-container h1{font-size:32px;border-bottom:2px solid var(--border);padding-bottom:12px}
    .preview-container p{line-height:1.7;margin-bottom:12px}
    .preview-container ul,.preview-container ol{margin-left:1.5em;margin-bottom:12px}
    .preview-container pre{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px;overflow-x:auto;margin:12px 0}
    .preview-container code{background:var(--bg);padding:2px 6px;border-radius:4px;font-size:0.9em;border:1px solid var(--border)}
    .preview-container pre code{background:transparent;padding:0;border:none}
    .preview-container table{border-collapse:collapse;width:100%;margin:16px 0}
    .preview-container th,.preview-container td{border:1px solid var(--border);padding:8px 12px;text-align:left}
    .preview-container th{background:var(--bg);font-weight:600}
    .preview-container blockquote{border-left:4px solid var(--accent);padding-left:16px;margin:16px 0;color:var(--muted);font-style:italic}
    .preview-container a{color:var(--accent);text-decoration:none}
    .preview-container a:hover{text-decoration:underline}
    .status-bar{background:var(--panel);border-top:1px solid var(--border);padding:8px 20px;font-size:12px;color:var(--muted);display:flex;justify-content:space-between;position:fixed;bottom:0;left:0;right:0;z-index:999}
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-content{background:var(--panel);padding:24px;border-radius:12px;border:1px solid var(--border);max-width:500px;width:90%}
    .modal-content h2{margin-bottom:16px;font-size:20px}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;font-size:13px;color:var(--muted)}
    .form-group input,.form-group select{width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--accent)}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px}
    .notification{position:fixed;top:80px;right:20px;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:16px 20px;box-shadow:0 4px 12px rgba(0,0,0,0.2);display:none;z-index:2000;min-width:300px}
    .notification.show{display:block;animation:slideIn 0.3s}
    .notification.success{border-left:4px solid var(--success)}
    .notification.error{border-left:4px solid var(--error)}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    @media (max-width:900px){.editor-wrap{grid-template-columns:1fr}.editor-pane:first-child{display:none}}
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
</head>
<body>
  <div class="top-bar">
    <div>
      <span class="file-name" id="file-name">Nuovo documento</span>
    </div>
    <div class="actions">
      <div class="theme-toggle">
        <button onclick="setTheme('dark')" data-theme="dark" class="active">üåô</button>
        <button onclick="setTheme('light')" data-theme="light">‚òÄÔ∏è</button>
      </div>
      <button class="btn" onclick="showTemplateModal()">üìã Template</button>
      <button class="btn" onclick="uploadImage()">üñºÔ∏è Immagine</button>
      <button class="btn primary" onclick="saveFile()">üíæ Salva</button>
      <a href="preview.html" class="btn">‚Üê Indietro</a>
    </div>
  </div>

  <div class="editor-wrap">
    <div class="editor-pane">
      <div class="pane-header">üìù Markdown</div>
      <div class="editor-container">
        <textarea id="editor" placeholder="Inizia a scrivere..."></textarea>
      </div>
    </div>
    <div class="editor-pane">
      <div class="pane-header">üëÅÔ∏è Anteprima</div>
      <div class="preview-container" id="preview"></div>
    </div>
  </div>

  <div class="status-bar">
    <div>
      <span id="word-count">0 parole</span> ‚Ä¢ 
      <span id="char-count">0 caratteri</span> ‚Ä¢ 
      <span id="line-count">0 righe</span>
    </div>
    <div id="save-status">Non salvato</div>
  </div>

  <!-- Template Modal -->
  <div class="modal" id="template-modal">
    <div class="modal-content">
      <h2>Scegli Template</h2>
      <div class="form-group">
        <label>Template</label>
        <select id="template-select">
          <option value="blank">Vuoto</option>
          <option value="note">Nota</option>
          <option value="lecture">Lezione</option>
          <option value="todo">TODO List</option>
        </select>
      </div>
      <div class="form-group">
        <label>Titolo</label>
        <input type="text" id="template-title" placeholder="Titolo del documento">
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal('template-modal')">Annulla</button>
        <button class="btn primary" onclick="applyTemplate()">Applica</button>
      </div>
    </div>
  </div>

  <!-- Save File Modal -->
  <div class="modal" id="save-modal">
    <div class="modal-content">
      <h2>Salva Nuovo File</h2>
      <div class="form-group">
        <label>Nome file</label>
        <input type="text" id="save-filename" placeholder="nuovo-documento.md">
      </div>
      <div class="form-group">
        <label>Cartella</label>
        <select id="save-folder">
          <option value="">Root (cartella principale)</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal('save-modal')">Annulla</button>
        <button class="btn primary" onclick="confirmSave()">Salva</button>
      </div>
    </div>
  </div>

  <!-- File input nascosto per upload immagini -->
  <input type="file" id="image-upload" accept="image/*" style="display:none">

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/5.1.1/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script>
    // Variabili globali
    let currentFile = null;
    let editor = document.getElementById('editor');
    let preview = document.getElementById('preview');
    let hasUnsavedChanges = false;

    // Gestione tema
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      document.querySelectorAll('.theme-toggle button').forEach(b => {
        b.classList.toggle('active', b.dataset.theme === theme);
      });
    }
    const savedTheme = localStorage.getItem('theme') || 'dark';
    setTheme(savedTheme);

    // Carica file da URL
    const urlParams = new URLSearchParams(window.location.search);
    const fileParam = urlParams.get('file');
    if (fileParam) {
      loadFile(fileParam);
    }

    async function loadFile(path) {
      try {
        const res = await fetch(`/api/file/${path}`);
        const data = await res.json();
        editor.value = data.content;
        currentFile = path;
        document.getElementById('file-name').textContent = data.name;
        updatePreview();
        hasUnsavedChanges = false;
      } catch (e) {
        showNotification('Errore caricamento file', 'error');
      }
    }

    // Auto-update preview
    editor.addEventListener('input', () => {
      updatePreview();
      updateStats();
      hasUnsavedChanges = true;
      document.getElementById('save-status').textContent = 'Non salvato';
    });

    function updatePreview() {
      const md = editor.value;
      marked.setOptions({ headerIds: true, mangle: false });
      preview.innerHTML = marked.parse(md);
      document.querySelectorAll('#preview pre code').forEach(el => hljs.highlightElement(el));
    }

    function updateStats() {
      const text = editor.value;
      const words = text.trim() ? text.trim().split(/\s+/).length : 0;
      const chars = text.length;
      const lines = text.split('\n').length;
      
      document.getElementById('word-count').textContent = words + ' parole';
      document.getElementById('char-count').textContent = chars + ' caratteri';
      document.getElementById('line-count').textContent = lines + ' righe';
    }

    // Salva file
    async function saveFile() {
      const content = editor.value;
      
      if (!currentFile) {
        // Nuovo file - mostra modal per selezione cartella
        showSaveModal();
      } else {
        // Aggiorna file esistente
        try {
          const res = await fetch(`/api/file/${currentFile}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
          });
          
          const data = await res.json();
          if (data.ok) {
            hasUnsavedChanges = false;
            document.getElementById('save-status').textContent = 'Salvato';
            showNotification('File salvato con successo', 'success');
          } else {
            showNotification('Errore: ' + (data.error || 'Unknown'), 'error');
          }
        } catch (e) {
          showNotification('Errore durante il salvataggio', 'error');
        }
      }
    }

    // Save Modal
    async function showSaveModal() {
      // Carica lista cartelle
      try {
        const res = await fetch('/api/files');
        const data = await res.json();
        
        const folderSelect = document.getElementById('save-folder');
        folderSelect.innerHTML = '<option value="">Root (cartella principale)</option>';
        
        // Estrai tutte le cartelle dalla struttura
        const folders = extractFolders(data);
        folders.forEach(folder => {
          const option = document.createElement('option');
          option.value = folder;
          option.textContent = 'üìÅ ' + folder;
          folderSelect.appendChild(option);
        });
        
        // Aggiungi opzione per creare nuova cartella
        const newFolderOption = document.createElement('option');
        newFolderOption.value = '__NEW__';
        newFolderOption.textContent = '‚ûï Crea nuova cartella...';
        newFolderOption.style.fontWeight = 'bold';
        newFolderOption.style.color = 'var(--accent)';
        folderSelect.appendChild(newFolderOption);
        
        // Gestisci selezione nuova cartella
        folderSelect.onchange = function() {
          if (this.value === '__NEW__') {
            const newFolder = prompt('Nome della nuova cartella:', '');
            if (newFolder) {
              // Aggiungi la nuova cartella come opzione
              const opt = document.createElement('option');
              opt.value = newFolder;
              opt.textContent = 'üìÅ ' + newFolder;
              folderSelect.insertBefore(opt, newFolderOption);
              folderSelect.value = newFolder;
            } else {
              folderSelect.value = '';
            }
          }
        };
        
        document.getElementById('save-modal').classList.add('active');
      } catch (e) {
        showNotification('Errore caricamento cartelle', 'error');
      }
    }

    function extractFolders(node, prefix = '') {
      const folders = [];
      
      // Gestisci struttura dell'API: {type: 'folder', name: '...', children: [...]}
      if (node.type === 'folder' && node.children) {
        for (const child of node.children) {
          if (child.type === 'folder') {
            const folderPath = prefix ? `${prefix}/${child.name}` : child.name;
            folders.push(folderPath);
            // Ricorsione per sottocartelle
            folders.push(...extractFolders(child, folderPath));
          }
        }
      }
      
      return folders;
    }

    async function confirmSave() {
      const filename = document.getElementById('save-filename').value.trim();
      if (!filename) {
        showNotification('Inserisci un nome file', 'error');
        return;
      }

      const folder = document.getElementById('save-folder').value;
      const content = editor.value;

      try {
        const res = await fetch('/api/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: filename, content, folder })
        });
        
        const data = await res.json();
        if (data.ok) {
          currentFile = (folder ? folder + '/' : '') + data.name;
          document.getElementById('file-name').textContent = data.name;
          hasUnsavedChanges = false;
          document.getElementById('save-status').textContent = 'Salvato';
          showNotification('File creato con successo', 'success');
          closeModal('save-modal');
        } else {
          showNotification('Errore: ' + (data.error || 'Unknown'), 'error');
        }
      } catch (e) {
        showNotification('Errore durante il salvataggio', 'error');
      }
    }

    // Template
    function showTemplateModal() {
      document.getElementById('template-modal').classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    async function applyTemplate() {
      const templateType = document.getElementById('template-select').value;
      const title = document.getElementById('template-title').value || 'Nuovo documento';
      
      try {
        const res = await fetch('/api/templates');
        const templates = await res.json();
        
        let content = templates[templateType].content;
        content = content.replace('{title}', title);
        content = content.replace('{date}', new Date().toLocaleDateString('it-IT'));
        
        editor.value = content;
        updatePreview();
        updateStats();
        closeModal();
      } catch (e) {
        showNotification('Errore caricamento template', 'error');
      }
    }

    // Upload immagine
    function uploadImage() {
      document.getElementById('image-upload').click();
    }

    document.getElementById('image-upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('file', file);
      
      try {
        const res = await fetch('/api/upload-image', {
          method: 'POST',
          body: formData
        });
        
        const data = await res.json();
        if (data.ok) {
          const markdown = `![${data.filename}](${data.url})`;
          editor.value += '\n' + markdown + '\n';
          updatePreview();
          updateStats();
          showNotification('Immagine caricata', 'success');
        } else {
          showNotification('Errore upload immagine', 'error');
        }
      } catch (e) {
        showNotification('Errore durante upload', 'error');
      }
    });

    // Notifications
    function showNotification(message, type = 'success') {
      const notif = document.getElementById('notification');
      notif.textContent = message;
      notif.className = `notification ${type} show`;
      setTimeout(() => {
        notif.classList.remove('show');
      }, 3000);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl+S per salvare
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveFile();
      }
      
      // Ctrl+B per bold
      if (e.ctrlKey && e.key === 'b') {
        e.preventDefault();
        insertMarkdown('**', '**');
      }
      
      // Ctrl+I per italic
      if (e.ctrlKey && e.key === 'i') {
        e.preventDefault();
        insertMarkdown('*', '*');
      }
    });

    function insertMarkdown(before, after) {
      const start = editor.selectionStart;
      const end = editor.selectionEnd;
      const text = editor.value;
      const selected = text.substring(start, end);
      
      editor.value = text.substring(0, start) + before + selected + after + text.substring(end);
      editor.focus();
      editor.selectionStart = start + before.length;
      editor.selectionEnd = end + before.length;
      
      updatePreview();
      updateStats();
    }

    // Warning quando si chiude con modifiche non salvate
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Init
    updateStats();
  </script>
</body>
</html>
